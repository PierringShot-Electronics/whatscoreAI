/**
 * WhatsCore.AI - Maverick Edition
 *
 * WhatsApp API Controller - v5.0.0 (FINAL & COMPLETE)
 * YENÄ°LÄ°K: BÃ¼tÃ¼n orijinal funksiyalar qorunub saxlanÄ±lÄ±b vÉ™ hamÄ±sÄ± dÃ¼zgÃ¼n export edilib.
 * BÃ¼tÃ¼n servislÉ™r (Order, Product, Service) tam inteqrasiya olunub.
 * Bu, sistemin son, stabil vÉ™ tam versiyasÄ±dÄ±r.
 */
// Lazy-load WhatsApp-specific classes to avoid pulling heavy deps during tests
let MessageMedia = null;
let Location = null;
function ensureWhatsAppClasses() {
  if (MessageMedia && Location) return;
  // In test mode, avoid requiring the library; only load when truly needed
  if (String(process.env.SKIP_WHATSAPP).toLowerCase() === 'true') {
    // Create stubs that throw if misused during tests
    MessageMedia = class { constructor() { throw new Error('MessageMedia unavailable in SKIP_WHATSAPP mode'); } static async fromUrl() { throw new Error('MessageMedia.fromUrl unavailable in SKIP_WHATSAPP mode'); } };
    Location = class { constructor() { throw new Error('Location unavailable in SKIP_WHATSAPP mode'); } };
    return;
  }
  ({ MessageMedia, Location } = require('whatsapp-web.js'));
}
const { logWithTimestamp } = require("../utils/logger");
const productManager = require("../services/productManager");
const serviceManager = require("../services/serviceManager");
const orderManager = require("../services/orderManager");

let whatsappClient;

function setWhatsAppClient(client) {
  whatsappClient = client;
  logWithTimestamp("âœ… WhatsApp Klient instansiyasÄ± API kontrollerinÉ™ Ã¶tÃ¼rÃ¼ldÃ¼.");
}

// --- Status vÉ™ Sessiya ---
async function getClientStatus(req, res) {
  if (!whatsappClient) return res.status(503).json({ status: "Error", message: "WhatsApp Klienti hazÄ±r deyil." });
  try {
    const state = await whatsappClient.getState();
    res.status(200).json({ status: "OK", clientState: state });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "Klient statusunu almaq mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function logoutClient(req, res) {
    if (!whatsappClient) return res.status(503).json({ status: "Error", message: "Klient hazÄ±r deyil." });
    try {
      await whatsappClient.logout();
      logWithTimestamp("ğŸšª WhatsApp KlientindÉ™n uÄŸurla Ã§Ä±xÄ±ÅŸ edildi.");
      res.status(200).json({ status: "OK", message: "WhatsApp KlientindÉ™n uÄŸurla Ã§Ä±xÄ±ÅŸ edildi." });
    } catch (error) {
      res.status(500).json({ status: "Error", message: "Ã‡Ä±xÄ±ÅŸ etmÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
    }
}

async function resetClientSession(req, res) {
  if (!whatsappClient) return res.status(503).json({ status: "Error", message: "WhatsApp Klient instansiyasÄ± hazÄ±r deyil." });
  try {
    await whatsappClient.destroy();
    logWithTimestamp("ğŸ”„ WhatsApp Klient sessiyasÄ± sÄ±fÄ±rlandÄ±. TÉ™tbiqi yenidÉ™n baÅŸladÄ±n.");
    res.status(200).json({ status: "OK", message: "Sessiya sÄ±fÄ±rlandÄ±. TÉ™tbiqi yenidÉ™n baÅŸladÄ±n." });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "SessiyanÄ± sÄ±fÄ±rlamaq mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}


// --- Mesaj GÃ¶ndÉ™rmÉ™ ---
async function sendText(req, res) {
  const { number, message } = req.body;
  if (!number || !message) return res.status(400).json({ status: "Error", message: "NÃ¶mrÉ™ vÉ™ mesaj boÅŸ ola bilmÉ™z." });
  try {
    const chatId = `${number}@c.us`;
    await whatsappClient.sendMessage(chatId, message);
    res.status(200).json({ status: "OK", message: "MÉ™tn mesajÄ± uÄŸurla gÃ¶ndÉ™rildi." });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "Mesaj gÃ¶ndÉ™rmÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function sendMedia(req, res) {
  const { number, fileUrl, caption } = req.body;
  if (!number || !fileUrl) return res.status(400).json({ status: "Error", message: "NÃ¶mrÉ™ vÉ™ fayl URL-i boÅŸ ola bilmÉ™z." });
  try {
    ensureWhatsAppClasses();
    const media = await MessageMedia.fromUrl(fileUrl, { unsafeMime: true });
    await whatsappClient.sendMessage(`${number}@c.us`, media, { caption: caption });
    res.status(200).json({ status: "OK", message: "Media mesajÄ± uÄŸurla gÃ¶ndÉ™rildi." });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "Media mesajÄ± gÃ¶ndÉ™rmÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function sendLocation(req, res) {
  const { number, latitude, longitude, description } = req.body;
  if (!number || !latitude || !longitude) return res.status(400).json({ status: "Error", message: "NÃ¶mrÉ™, enlik vÉ™ uzunluq boÅŸ ola bilmÉ™z." });
  try {
    ensureWhatsAppClasses();
    const location = new Location(latitude, longitude, description);
    await whatsappClient.sendMessage(`${number}@c.us`, location);
    res.status(200).json({ status: "OK", message: "MÉ™kan uÄŸurla gÃ¶ndÉ™rildi." });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "MÉ™kan gÃ¶ndÉ™rmÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function sendContact(req, res) {
    const { number, contactId } = req.body;
    if (!number || !contactId) return res.status(400).json({ status: "Error", message: "NÃ¶mrÉ™ vÉ™ ya kontakt ID-si boÅŸ ola bilmÉ™z." });
    try {
        const contact = await whatsappClient.getContactById(contactId);
        await whatsappClient.sendMessage(`${number}@c.us`, contact);
        res.status(200).json({ status: "OK", message: "Kontakt uÄŸurla gÃ¶ndÉ™rildi." });
    } catch (error) {
        res.status(500).json({ status: "Error", message: "Kontakt gÃ¶ndÉ™rmÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
    }
}

// Flexible send endpoint: supports GET and POST. Query/body params: type=text|media|location|contact, number, message, fileUrl, caption, latitude, longitude
async function sendAny(req, res) {
  const data = Object.assign({}, req.query || {}, req.body || {});
  const { type = 'text', number } = data;
  if (!number) return res.status(400).json({ status: 'Error', message: 'number is required' });
  try {
    const chatId = `${number}@c.us`;
    if (!whatsappClient) return res.status(503).json({ status: 'Error', message: 'WhatsApp client not initialized' });
    if (type === 'text') {
      await whatsappClient.sendMessage(chatId, data.message || data.text || '');
    } else if (type === 'media') {
      const media = await MessageMedia.fromUrl(data.fileUrl, { unsafeMime: true });
      await whatsappClient.sendMessage(chatId, media, { caption: data.caption });
    } else if (type === 'location') {
      const loc = new Location(data.latitude, data.longitude, data.description || '');
      await whatsappClient.sendMessage(chatId, loc);
    } else if (type === 'contact') {
      const contact = await whatsappClient.getContactById(data.contactId);
      await whatsappClient.sendMessage(chatId, contact);
    } else {
      return res.status(400).json({ status: 'Error', message: 'Unsupported type' });
    }
    return res.status(200).json({ status: 'OK', message: 'Sent' });
  } catch (error) {
    return res.status(500).json({ status: 'Error', message: error.message });
  }
}

// Blacklist / STOP management via API
function addToBlacklistApi(req, res) {
  const { chatId, reason } = Object.assign({}, req.body || {}, req.query || {});
  if (!chatId) return res.status(400).json({ status: 'Error', message: 'chatId is required' });
  try { require('../services/historyManager').addToBlacklist(chatId, reason); return res.status(200).json({ status: 'OK' }); } catch (e) { return res.status(500).json({ status: 'Error', message: e.message }); }
}

function removeFromBlacklistApi(req, res) {
  const { chatId } = Object.assign({}, req.body || {}, req.query || {});
  if (!chatId) return res.status(400).json({ status: 'Error', message: 'chatId is required' });
  try { require('../services/historyManager').removeFromBlacklist(chatId); return res.status(200).json({ status: 'OK' }); } catch (e) { return res.status(500).json({ status: 'Error', message: e.message }); }
}

function addStopApi(req, res) {
  const { chatId } = Object.assign({}, req.body || {}, req.query || {});
  if (!chatId) return res.status(400).json({ status: 'Error', message: 'chatId is required' });
  try { require('../services/historyManager').addStop(chatId); return res.status(200).json({ status: 'OK' }); } catch (e) { return res.status(500).json({ status: 'Error', message: e.message }); }
}

function removeStopApi(req, res) {
  const { chatId } = Object.assign({}, req.body || {}, req.query || {});
  if (!chatId) return res.status(400).json({ status: 'Error', message: 'chatId is required' });
  try { require('../services/historyManager').removeStop(chatId); return res.status(200).json({ status: 'OK' }); } catch (e) { return res.status(500).json({ status: 'Error', message: e.message }); }
}

// --- MÉ™lumatlarÄ±n Ä°darÉ™si (Products, Services, Orders) ---
function getProducts(req, res) {
  const q = req.query.q;
  if (q) {
    const results = productManager.searchKnowledgeBase(q, { limit: 10 });
    return res.status(200).json({ status: "OK", query: q, count: results.length, data: results });
  }
  res.status(200).json({ status: "OK", data: productManager.getProducts() });
}

function getServices(req, res) {
    res.status(200).json({ status: "OK", data: serviceManager.getServices() });
}

function getAllOrders(req, res) {
    res.status(200).json({ status: "OK", data: orderManager.getAllOrders() });
}

async function createOrder(req, res) {
  try {
    // Normalize payload to support item_id/itemId/item and customer_phone variants
    const body = req.body || {};
    const payload = {
      lead_id: body.lead_id || body.leadId || body.lead || '',
      customer_phone: body.customer_phone || body.customerPhone || body.customer || '',
      item_id: body.item_id || body.itemId || (body.item && (body.item.id || body.itemId)) || body.item || null,
      quantity: typeof body.quantity !== 'undefined' ? body.quantity : (body.qty || 1),
    };

    const newOrder = await orderManager.createOrder(payload);
    if (whatsappClient && newOrder.customer_phone) {
      const phoneForSend = newOrder.customer_phone.includes('@') ? newOrder.customer_phone : `${newOrder.customer_phone}@c.us`;
      const confirmationMessage = `HÃ¶rmÉ™tli mÃ¼ÅŸtÉ™ri, ${newOrder.order_id} nÃ¶mrÉ™li sifariÅŸiniz uÄŸurla qeydÉ™ alÄ±ndÄ±. TÉ™ÅŸÉ™kkÃ¼r edirik!`;
      try { await whatsappClient.sendMessage(phoneForSend, confirmationMessage); } catch (e) { /* ignore send errors */ }
    }
    res.status(201).json({ status: "OK", message: "SifariÅŸ yaradÄ±ldÄ±.", data: newOrder });
  } catch (error) {
    res.status(400).json({ status: "Error", message: error.message });
  }
}

// --- SÃ¶hbÉ™t (Chat) Ä°darÉ™etmÉ™si ---
async function getChats(req, res) {
  try {
    const chats = await whatsappClient.getChats();
    res.status(200).json({
      status: "OK",
      data: chats.map(c => ({ id: c.id._serialized, name: c.name, isGroup: c.isGroup, unreadCount: c.unreadCount })),
    });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "SÃ¶hbÉ™tlÉ™ri almaq mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function archiveChat(req, res) {
  const { chatId } = req.body;
  if (!chatId) return res.status(400).json({ status: "Error", message: "SÃ¶hbÉ™t ID-si boÅŸ ola bilmÉ™z." });
  try {
    const chat = await whatsappClient.getChatById(chatId);
    await chat.archive();
    res.status(200).json({ status: "OK", message: `SÃ¶hbÉ™t ${chatId} uÄŸurla arxivlÉ™ndi.` });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "SÃ¶hbÉ™ti arxivlÉ™mÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function unarchiveChat(req, res) {
  const { chatId } = req.body;
  if (!chatId) return res.status(400).json({ status: "Error", message: "SÃ¶hbÉ™t ID-si boÅŸ ola bilmÉ™z." });
  try {
    const chat = await whatsappClient.getChatById(chatId);
    await chat.unarchive();
    res.status(200).json({ status: "OK", message: `SÃ¶hbÉ™t ${chatId} uÄŸurla arxivdÉ™n Ã§Ä±xarÄ±ldÄ±.` });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "SÃ¶hbÉ™ti arxivdÉ™n Ã§Ä±xarmaq mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function pinMessage(req, res) {
    const { messageId } = req.body;
    if (!messageId) return res.status(400).json({ status: "Error", message: "Mesaj ID-si boÅŸ ola bilmÉ™z." });
    try {
      const message = await whatsappClient.getMessageById(messageId);
      await message.pin();
      res.status(200).json({ status: "OK", message: `Mesaj ${messageId} uÄŸurla pinlÉ™ndi.` });
    } catch (error) {
      res.status(500).json({ status: "Error", message: "MesajÄ± pinlÉ™mÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
    }
}

async function unpinMessage(req, res) {
    const { messageId } = req.body;
    if (!messageId) return res.status(400).json({ status: "Error", message: "Mesaj ID-si boÅŸ ola bilmÉ™z." });
    try {
        const message = await whatsappClient.getMessageById(messageId);
        await message.unpin();
        res.status(200).json({ status: "OK", message: `Mesaj ${messageId} pini uÄŸurla lÉ™ÄŸv edildi.` });
    } catch (error) {
        res.status(500).json({ status: "Error", message: "MesajÄ±n pinini lÉ™ÄŸv etmÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
    }
}

async function markChatAsRead(req, res) {
    const { chatId } = req.body;
    if (!chatId) return res.status(400).json({ status: "Error", message: "SÃ¶hbÉ™t ID-si boÅŸ ola bilmÉ™z." });
    try {
      const chat = await whatsappClient.getChatById(chatId);
      await chat.sendSeen();
      res.status(200).json({ status: "OK", message: `SÃ¶hbÉ™t ${chatId} oxunmuÅŸ kimi iÅŸarÉ™lÉ™ndi.` });
    } catch (error) {
      res.status(500).json({ status: "Error", message: "SÃ¶hbÉ™ti oxunmuÅŸ kimi iÅŸarÉ™lÉ™mÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
    }
}
  
async function markChatAsUnread(req, res) {
    const { chatId } = req.body;
    if (!chatId) return res.status(400).json({ status: "Error", message: "SÃ¶hbÉ™t ID-si boÅŸ ola bilmÉ™z." });
    try {
        const chat = await whatsappClient.getChatById(chatId);
        await chat.markUnread();
        res.status(200).json({ status: "OK", message: `SÃ¶hbÉ™t ${chatId} oxunmamÄ±ÅŸ kimi iÅŸarÉ™lÉ™ndi.` });
    } catch (error) {
        res.status(500).json({ status: "Error", message: "SÃ¶hbÉ™ti oxunmamÄ±ÅŸ kimi iÅŸarÉ™lÉ™mÉ™k mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
    }
}

// --- Kontakt (Contact) Ä°darÉ™etmÉ™si ---
async function getContactInfo(req, res) {
  const { number } = req.query;
  if (!number) return res.status(400).json({ status: "Error", message: "NÃ¶mrÉ™ boÅŸ ola bilmÉ™z." });
  try {
    const contact = await whatsappClient.getContactById(`${number}@c.us`);
    res.status(200).json({ status: "OK", data: { id: contact.id._serialized, name: contact.name || contact.pushname, isBlocked: contact.isBlocked, isBusiness: contact.isBusiness }});
  } catch (error) {
    res.status(500).json({ status: "Error", message: "Kontakt mÉ™lumatÄ±nÄ± almaq mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function getProfilePicUrl(req, res) {
  const { number } = req.query;
  if (!number) return res.status(400).json({ status: "Error", message: "NÃ¶mrÉ™ boÅŸ ola bilmÉ™z." });
  try {
    const url = await whatsappClient.getProfilePicUrl(`${number}@c.us`);
    res.status(200).json({ status: "OK", data: { profilePicUrl: url } });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "Profil ÅŸÉ™kli URL-i almaq mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

async function getAllContacts(req, res) {
  try {
    const contacts = await whatsappClient.getContacts();
    res.status(200).json({
      status: "OK",
      data: contacts.map(c => ({ id: c.id._serialized, name: c.name || c.pushname || c.id._serialized, isBusiness: c.isBusiness })),
    });
  } catch (error) {
    res.status(500).json({ status: "Error", message: "BÃ¼tÃ¼n kontaktlarÄ± almaq mÃ¼mkÃ¼n olmadÄ±.", error: error.message });
  }
}

module.exports = {
  setWhatsAppClient,
  // Sessiya vÉ™ Status
  getClientStatus,
  logoutClient,
  resetClientSession,
  // Mesajlar
  sendText,
  sendMedia,
  sendLocation,
  sendContact,
  // MÉ™lumatlar
  getProducts,
  getServices,
  getAllOrders,
  createOrder,
  // SÃ¶hbÉ™tlÉ™r
  getChats,
  archiveChat,
  unarchiveChat,
  pinMessage,
  unpinMessage,
  markChatAsRead,
  markChatAsUnread,
  // Kontaktlar
  getContactInfo,
  getProfilePicUrl,
  getAllContacts,
  // Flexible send and moderation
  sendAny,
  addToBlacklistApi,
  removeFromBlacklistApi,
  addStopApi,
  removeStopApi,
};
